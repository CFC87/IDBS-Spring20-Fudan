<!-- Fix MathJax rendering on iOS Safari due to rendering long numbers as phone numbers. -->




<!doctype html>
<html lang="en" class="no-js">
  <head>
    
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Course website for introduction to database systems at Fudan University">
      
      
        <link rel="canonical" href="https://zfhu.ac.cn/IDBS-Spring20-Fudan/assignment2/readme/">
      
      
        <meta name="author" content="Zhifeng Hu">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="/static/assets/fudan.svg">
      <meta name="generator" content="mkdocs-1.1, mkdocs-material-4.6.3">
    
    <meta name="format-detection" content="telephone=no">

    
      
        <title>Instruction - IDBS-Spring20-Fudan</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.adb8469c.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="">
      
    
    
      <script src="../../assets/javascripts/modernizr.86422ebf.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../static/css/katex.css">
    
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css">
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-149024530-1", "auto")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="black" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#assignment-2-evaluator" tabindex="0" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://zfhu.ac.cn/IDBS-Spring20-Fudan" title="IDBS-Spring20-Fudan" aria-label="IDBS-Spring20-Fudan" class="md-header-nav__button md-logo">
          
            <i class="md-icon">code</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              IDBS-Spring20-Fudan
            </span>
            <span class="md-header-nav__topic">
              
                Instruction
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" aria-label="search" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/ichn-hu/IDBS-Spring20-Fudan/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    ichn-hu/IDBS-Spring20-Fudan
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." class="md-tabs__link">
        Welcome
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../../assignment1/readme/" class="md-tabs__link">
          Assignment 1
        </a>
      
    </li>
  

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="./" class="md-tabs__link md-tabs__link--active">
          Assignment 2
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://zfhu.ac.cn/IDBS-Spring20-Fudan" title="IDBS-Spring20-Fudan" class="md-nav__button md-logo">
      
        <i class="md-icon">code</i>
      
    </a>
    IDBS-Spring20-Fudan
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/ichn-hu/IDBS-Spring20-Fudan/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    ichn-hu/IDBS-Spring20-Fudan
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Welcome" class="md-nav__link">
      Welcome
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2">
    
    <label class="md-nav__link" for="nav-2">
      Assignment 1
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Assignment 1
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../assignment1/readme/" title="Instruction" class="md-nav__link">
      Instruction
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Assignment 2
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Assignment 2
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Instruction
      </label>
    
    <a href="./" title="Instruction" class="md-nav__link md-nav__link--active">
      Instruction
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#update-your-cloned-git-repository" class="md-nav__link">
    Update Your Cloned Git Repository
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy-provided-code-to-your-working-directory" class="md-nav__link">
    Copy Provided Code to Your Working Directory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-new-branch-for-development" class="md-nav__link">
    Create a New Branch for Development
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modify-configuration" class="md-nav__link">
    Modify Configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concurrent-comparison-result-insert" class="md-nav__link">
    Concurrent Comparison Result Insert
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluate-the-score" class="md-nav__link">
    Evaluate the Score
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#get-the-score" class="md-nav__link">
    Get the Score
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#submit-your-solution" class="md-nav__link">
    Submit your solution
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#setup" class="md-nav__link">
    Setup
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#update-your-cloned-git-repository" class="md-nav__link">
    Update Your Cloned Git Repository
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#copy-provided-code-to-your-working-directory" class="md-nav__link">
    Copy Provided Code to Your Working Directory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-a-new-branch-for-development" class="md-nav__link">
    Create a New Branch for Development
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#modify-configuration" class="md-nav__link">
    Modify Configuration
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concurrent-comparison-result-insert" class="md-nav__link">
    Concurrent Comparison Result Insert
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluate-the-score" class="md-nav__link">
    Evaluate the Score
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#get-the-score" class="md-nav__link">
    Get the Score
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#submit-your-solution" class="md-nav__link">
    Submit your solution
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/ichn-hu/IDBS-Spring20-Fudan/edit/master/content/assignment2/readme.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="assignment-2-evaluator">Assignment 2, Evaluator<a class="headerlink" href="#assignment-2-evaluator" title="Permanent link">&para;</a></h1>
<p>In the first assignment, you have written several SQLs to help you build basic experience playing with MySQL, in this assignment you are going to continue the journey, but this time, you will use a programming language to interact with MySQL, namely, golang.</p>
<p>Golang, developed by Google, is a statically typed programming language (we'll refer to golang as Go in the following content). It is becoming more and more popular in the recent several years, companies like bilibili<sup id="fnref:1"><a class="footnote-ref" href="#fn:1">1</a></sup> <sup id="fnref:3"><a class="footnote-ref" href="#fn:3">3</a></sup> and zhihu<sup id="fnref:2"><a class="footnote-ref" href="#fn:2">2</a></sup> and so many more are using Go to build the backend of their applications. And the idea of cloud native and microservice are built almost on top of Go, just to name a few softwares in Go, docker, kubernetes, and TiDB (a distributed database compatible with MySQL, we probably will also play with it in the future). So it is very desirable and meaningful to start to learn this language.</p>
<p>Go is also very simple, it is built with simplicity in mind, as long as you know how to write C code, it won't be hard
to learn Go. However, Go does introduce many ideas that perhaps you are not familiar with, most of the ideas are
related to concurrency, such as <code>channel</code> and <code>goroutine</code>, we will be using these features extensively in the assignments,
since database systems are built to allow (or welcome) concurrent accesses, and Go has a good fame of being a
concurrency friendly programming language.</p>
<p>You might be frightened that you need to learn a new programming language, but it is a must for a good programmer to be
fluent in many programming languages, and it won't be too hard given you already know at least one programming
language. To make your learning experience less painful, follow the instructions below to learn it.</p>
<ul>
<li><a href="https://golang.org/doc/install">Install Go compiler and setup the environment</a>, we will be using the latest Go version, 1.14.</li>
<li>Join <a href="https://tour.golang.org/">the tour of Go</a>, walk through the whole tutorial, and come back often when you have
  problems writing Go in the future. This is an excellent tutorial, and your TA also learned Go from here. It would take at least 2
  days for you to fully understand the tutorial, so start early. Also, try some of the examples on your local machine,
  which will help you better understand the toolchain of Go. Note, the most important thing for you to learn is the
  concurrency part, you need to understand goroutine (kind of like a light-weighted thread) and <code>sync.Mutex</code>, since you
  will need it in this assignment. As for the syntax of Go, it is quite similar with C, so do not worry, you could just
  skim this part and come back when you need it.</li>
<li>Read the provided code and make sure your understand every line of the code. If you don't, check the tutorial again.
  And if you are still confused, do not hesitate to ask questions in the comment bellow.</li>
<li>Try to use GoLand for development, it provides the best Go development environment in your TA's opinion, and it is free for educational
  purpose. You could connect GoLand with your MySQL server and GoLand will be able to help you write your SQL.</li>
</ul>
<h2 id="setup">Setup<a class="headerlink" href="#setup" title="Permanent link">&para;</a></h2>
<p>To setup the environment for this assignment, you have the following steps to finish.</p>
<h3 id="update-your-cloned-git-repository">Update Your Cloned Git Repository<a class="headerlink" href="#update-your-cloned-git-repository" title="Permanent link">&para;</a></h3>
<p>Your local repository only have your own code, in order to get the content for this assignment, you need to fetch data
from GitHub. Use the following commands:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ git remote add upstream xxx <span class="c1"># add your TA&#39;s repository to the romote</span>
$ git fetch upstream <span class="c1"># this command fetches the update in your TA&#39;s repository, it would take a while</span>
$ git merge upstream/master <span class="c1"># merge the updates into your master, you can also do `git rebase upstream/master` if you used another branch other than master previously for assignment 1</span>
</code></pre></div>
</td></tr></table>

<h3 id="copy-provided-code-to-your-working-directory">Copy Provided Code to Your Working Directory<a class="headerlink" href="#copy-provided-code-to-your-working-directory" title="Permanent link">&para;</a></h3>
<p>The code provided is under <code>assignments/ass2/evaluator/</code>. Similarly you have to create your working directory under
<code>assignments/ass2/submission/</code></p>
<p>Suppose your current directory is the root of the repository.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ mkdir assignments/ass2/submission/YOURSTUDENTID <span class="c1"># put your student id here</span>
$ cp assignments/ass2/evaluator/* assignments/ass2/submission/YOURSTUDENTID/ <span class="c1"># copy provided code into your working directory</span>
</code></pre></div>
</td></tr></table>

<p>You can only modify the files in your own working directory, any attempts to modify files outside your working directory
will make your submission invalid.</p>
<p>Especially, only <code>utils.go</code> in your working directory will be considered in this assignment (other files will be ignored, see
<code>assignments/ass2/submission/.gitignore</code>). With this said, you could actually modify other provided files like
<code>main.go</code> if it helps you with understanding the code or debugging your own code, but your modification will not be
considered when we evaluate your submission, and you should make sure your code in <code>utils.go</code> can work with the original
codebase.</p>
<p>You should generally only put your code between <code>YOUR CODE BEGIN</code> and <code>YOUR CODE END</code>. The evaluation of assignment 2 will be based on the three functions you filled in in <code>utils.go</code>.</p>
<p>As for the packages, you can not introduce any other external packages (the <code>go.mod</code> file will be ignored for your submission, even if you do, we will not be able to run it). You are free to use other internal packages, as a reference the TA's solution only uses <code>sync</code> and <code>reflect</code>.</p>
<h3 id="create-a-new-branch-for-development">Create a New Branch for Development<a class="headerlink" href="#create-a-new-branch-for-development" title="Permanent link">&para;</a></h3>
<p>It is your TA's fault that he didn't tell you this in assignment 1. It would be better that you don't work on the master
branch, because that will make the git history messy. Create a new branch and develop your code in the new branch, you
could name the branch <code>ass2</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ <span class="n">git</span> <span class="n">checkout</span> -<span class="n">b</span> <span class="n">ass2</span> <span class="c1"># create and checkout to a new branch ass2</span>
$ <span class="n">git</span> <span class="nb">add</span> . &amp;&amp; <span class="n">git</span> <span class="n">commit</span> -<span class="sr">m &quot;update from upstream, start ass2&quot;</span> <span class="c1"># commit your modification (only `utils.go` will be tracked) and start working</span>
</code></pre></div>
</td></tr></table>

<h3 id="modify-configuration">Modify Configuration<a class="headerlink" href="#modify-configuration" title="Permanent link">&para;</a></h3>
<p>Now edit <code>utils.go</code>, in the first <code>YOUR CODE</code> block, put your student id in <code>EvaluateID</code>, <code>../../../ass1/submission/</code>
for <code>SubmissionDir</code>, and the user name and password to connect your MySQL server.</p>
<p>You could then run</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ go run main.go utils.go
</code></pre></div>
</td></tr></table>

<p>at your working directory, you should see</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>submission created
</code></pre></div>
</td></tr></table>

<p>in the output if the configuration is correct. If you did not see this line, check the error message and search online, and try to fix it.</p>
<p>You could ignore the printed error message above this line, these messages are for you to know if there
are any problems with the submissions of assignment 1. They are only relevant if you found your solution for assignment 1 is not compliant with
the evaluator, then these error messages tell you why.</p>
<p>If you want to argue about your submission for assignment 1, create another pull request with your modified submission for assignment 1 (only modify files in your working directory for assignment 1) and explain why you think you
deserve a higher score in the pull request, mistakes like creating tables using all UPPERCASE names sound like possible to have a second chance.</p>
<p>Each submission created will have an integer array <code>score</code>, and <code>score[0]</code> is 0 if the submission's <code>create_table.sql</code> is wrong, otherwise it will be 1. <code>score[1]</code> to <code>score[8]</code> stands for the score for query 1 to query 8 in assignment 1, and they are obtained in the following manner.</p>
<h2 id="concurrent-comparison-result-insert">Concurrent Comparison Result Insert<a class="headerlink" href="#concurrent-comparison-result-insert" title="Permanent link">&para;</a></h2>
<p>Take a look at <code>compareAndInsert</code>, which compares each submissions with all the submissions on each query, and insert a record for the comparison in the table <code>comparison_result</code>.</p>
<p>The problem of this function is that it is single-threaded. As you might know, access database is IO-bounded, the CPU might wait for a lot of time for the response of the database, so it makes sense to make the insert concurrent so that the CPU could get more busy and making the insert faster.</p>
<p>The single thread version provided in the provided code takes almost 1 minutes on your TA's laptop to insert 7200
records in the database. This is too slow! The QPS (query per second) is about 7200 / 60 = 120.</p>
<p>With the help of goroutine, it can be easily made concurrent, so please make it concurrent and improve the QPS in <code>ConcurrentCompareAndInsert</code>. As a reference, it takes less than 4 seconds with your TA's simple concurrent version, a speed up of 15x.</p>
<p>You could also do batch insert, which could be even faster, but you won't be able to play with concurrency. If you are interested, you could write a <code>CompareAndBatchedInsert</code> function in <code>utils.go</code> and test how faster it could be, however this part is unrated.</p>
<p>Also as a reference, your kind TA provided you a concurrent <code>createSubmissions</code> in <code>main.go</code>, take a look if you don't know how to start.</p>
<p>Also as a kind note, <code>sql.DB</code> is not thread-safe, you need multiple <code>sql.DB</code> if you want concurrent access of the database, and figuring out (by search it online) what is closure, and how to pass variable to a closure might be helpful.</p>
<p>Run</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ go run main.go utils.go
</code></pre></div>
</td></tr></table>

<p>again, and you will see</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>ConcurrentCompareAndInsert takes  xxxs
</code></pre></div>
</td></tr></table>

<p>instead of</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>ConcurrentCompareAndInsert Not Implemented
</code></pre></div>
</td></tr></table>

<h2 id="evaluate-the-score">Evaluate the Score<a class="headerlink" href="#evaluate-the-score" title="Permanent link">&para;</a></h2>
<p>Once you get all the comparison result, it is time to get the score for each submission on each query.</p>
<p>We evaluate the submission using the following rule. In <code>comparison_result</code>, for each query, each
submission has record of <code>is_equal</code> to every submissions, and the sum of <code>is_equal</code> is the vote of
the submission for the query, if the submission has the highest vote, i.e. most of submissions agreed with this submission's result on the query, the score of the submission on this query will be 1, otherwise 0.</p>
<p>You need to use <strong>a single query</strong> to insert the score result in the table <code>score</code> created in <code>createScoreTable</code>, where <code>submitter</code> is the ID of the submitter of the submission, item ranges from 1 to 8 and stands for each query, score being 0 or 1 means the score of <code>submitter</code> on query <code>item</code>, and <code>vote</code> is the vote mentioned above for sanity check.</p>
<p>You need to finish <code>GetScoreSQL</code> in <code>utils.go</code>, which only returns a single string containing the query sent to MySQL that reads from <code>comparison_result</code> and inserts into <code>score</code>.</p>
<p>This query can be rather complex and challenging, here are some hints that might be helpful</p>
<ul>
<li>UNION is a good wait to combine result of multiple queries</li>
<li>Common Table Expression (CTE) can be helpful if you want to reuse the result of a subquery</li>
<li><code>order by</code> can be used with multiple column</li>
<li>You can insert with values replaced by a select query</li>
<li>Window functions might be helpful, check it out if you are interested, but you can finish this query without using it</li>
</ul>
<p>You are free to hack around using any features of MySQL you want (version 8.0), there are many possible ways, as long as you can make it with the <code>GetScoreSQL</code> function, you will get the score.</p>
<p>Run</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ go run main.go utils.go
</code></pre></div>
</td></tr></table>

<p>again, and you will see</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>GetScoreSQL inserted xxx records into score
</code></pre></div>
</td></tr></table>

<p>instead of</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>GetScoreSQL Not Implemented
</code></pre></div>
</td></tr></table>

<h2 id="get-the-score">Get the Score<a class="headerlink" href="#get-the-score" title="Permanent link">&para;</a></h2>
<p>Finally, you need to fill in each submission's <code>score</code> (i.e. <code>Submission.score</code>) with the data in table <code>score</code>. Finish <code>GetScore</code> and read score from table <code>score</code> and you will get output like</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>...
18307130252 1 1 1 1 1 1 1 1 0
18300200015 1 1 1 1 1 1 1 1 0
18307130031 1 1 1 1 1 1 1 0 1
18307130112 1 1 1 1 1 1 0 1 0
...
</code></pre></div>
</td></tr></table>

<p>if you run <code>go run main.go utils.go</code>.</p>
<h2 id="submit-your-solution">Submit your solution<a class="headerlink" href="#submit-your-solution" title="Permanent link">&para;</a></h2>
<p>As you have done for assignment 1, commit your change for <code>utils.go</code> and create a pull request to submit it.</p>
<p>Since you used another branch (<code>ass2</code> as your TA told you above), do the following to push your code to your
repository</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><code>$ git push --set-upstream origin ass2
</code></pre></div>
</td></tr></table>

<p>Also do not look at other's submission before your submission get merged.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>https://github.com/bilibili/kratos&#160;<a class="footnote-backref" href="#fnref:1" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>https://zhuanlan.zhihu.com/p/48039838&#160;<a class="footnote-backref" href="#fnref:2" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>https://www.bilibili.com/video/av29079011/&#160;<a class="footnote-backref" href="#fnref:3" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
</ol>
</div>
                
                  
                
                
              
              
<script src="https://utteranc.es/client.js"
        repo="ichn-hu/IDBS-Spring20-Fudan"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>

            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../../assignment1/readme/" title="Instruction" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Instruction
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Built by <a href="http://github.com/ichn-hu">ichn-hu</a> &copy; 2020
          </div>
        
        powered by
        <a href="https://www.mkdocs.org" target="_blank" rel="noopener">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/ichn-hu" target="_blank" rel="noopener" title="github" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://github.com/ichn-hu/IDBS-Spring20-Fudan" target="_blank" rel="noopener" title="quote-left" class="md-footer-social__link fa fa-quote-left"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.c33a9706.js"></script>
      
      <script>app.initialize({version:"1.1",url:{base:"../.."}})</script>
      
        <script src="../../static/js/katex.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.js"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/contrib/auto-render.min.js"></script>
      
    
  </body>
</html>